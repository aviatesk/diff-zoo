<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Back &amp; Forth · diff-zoo</title><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">diff-zoo</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">README</a></li><li><span class="tocitem">Notebooks</span><ul><li><a class="tocitem" href="../intro/">Intro</a></li><li class="is-active"><a class="tocitem" href>Back &amp; Forth</a><ul class="internal"><li><a class="tocitem" href="#Explanation-1:-Multiple-Variables"><span>Explanation 1: Multiple Variables</span></a></li><li><a class="tocitem" href="#Explanation-2:-Vector-Calculus"><span>Explanation 2: Vector Calculus</span></a></li></ul></li><li><a class="tocitem" href="../forward/">Forward</a></li><li><a class="tocitem" href="../tracing/">Tracing</a></li><li><a class="tocitem" href="../reverse/">Reverse</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Notebooks</a></li><li class="is-active"><a href>Back &amp; Forth</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Back &amp; Forth</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/aviatesk/diff-zoo/blob/master/src/backandforth.jl" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Forward-and-Reverse-Mode-Differentiation"><a class="docs-heading-anchor" href="#Forward-and-Reverse-Mode-Differentiation">Forward- and Reverse-Mode Differentiation</a><a id="Forward-and-Reverse-Mode-Differentiation-1"></a><a class="docs-heading-anchor-permalink" href="#Forward-and-Reverse-Mode-Differentiation" title="Permalink"></a></h1><pre><code class="language-julia">include(&quot;utils.jl&quot;);</code></pre><p>Differentiation tools are frequently described as implementing &quot;forward mode&quot; or &quot;reverse mode&quot; AD. This distinction was briefly covered in the intro notebook, but here we&#39;ll go into more detail. We&#39;ll start with an intuition for what the distinction <em>means</em> in terms of the differentiation process; then we&#39;ll discuss why it&#39;s an important consideration in practice.</p><p>Consider a simple mathematical expression:</p><pre><code class="language-julia">y = :(sin(x^2) * 5)</code></pre><pre class="documenter-example-output">:(sin(x ^ 2) * 5)</pre><p>Written as a Wengert list:</p><pre><code class="language-julia">Wengert(y)</code></pre><pre class="documenter-example-output">Wengert List
y1 = x ^ 2
y2 = sin(y1)
y3 = y2 * 5
</pre><p>The ability to take derivatives mechanically relies on two things: Firstly, we know derivatives for each basic function in our program (e.g. <span>$\frac{dy_2}{dy_1}=cos(y_1)$</span>). Secondly, we have a rule of composition called the <em>chain rule</em> which lets us compose these basic derivatives together.</p><p class="math-container">\[\frac{dy}{dx} = \frac{dy_1}{dx} \times \frac{dy_2}{dy_1} \times \frac{dy}{dy_2}\]</p><p>More specifically:</p><p class="math-container">\[\begin{align}
\frac{dy}{dx} &amp;= 2x \times cos(y_1) \times 5 \\
              &amp;= 2x \times cos(x^2) \times 5
\end{align}\]</p><p>The forward/reverse distinction basically amounts to: given that we do multiplications one at a time, do we evaluate <span>$\frac{dy_1}{dx} \times \frac{dy_2}{dy_1}$</span> first, or <span>$\frac{dy_2}{dy_1} \times \frac{dy}{dy_2}$</span>? (This seems like a pointless question right now, given that either gets us the same results, but bear with me.)</p><p>It&#39;s easier to see the distinction if we think algorithmically. Given some enormous Wengert list with <span>$n$</span> instructions, we have two ways to differentiate it:</p><p><strong>(1)</strong>: Start with the known quantity <span>$\frac{dy_0}{dx} = \frac{dx}{dx} = 1$</span> at the beginning of the list. Look up the derivative for the next instruction <span>$\frac{dy_{i+1}}{dy_i}$</span> and multiply out the top, getting <span>$\frac{dy_1}{dx}$</span>, <span>$\frac{dy_2}{dx}$</span>, ... <span>$\frac{dy_{n-1}}{dx}$</span>, <span>$\frac{dy}{dx}$</span>. Because we walked forward over the Wengert list, this is called <em>forward mode</em>. Each intermediate derivative <span>$\frac{dy_i}{dx}$</span> is known as a <em>perturbation</em>.</p><p><strong>(2)</strong>: Start with the known quantity <span>$\frac{dy}{dy_n} = \frac{dy}{dy} = 1$</span> at the end of the list. Look up the derivative for the previous instruction <span>$\frac{dy_i}{dy_{i-1}}$</span> and multiply out the bottom, getting <span>$\frac{dy}{dy_n}$</span>, <span>$\frac{dy}{dy_{n-1}}$</span>, ... <span>$\frac{dy}{dy_1}$</span>, <span>$\frac{dy}{dx}$</span>. Because we walked in reverse over the Wengert list, this is called <em>reverse mode</em>. Each intermediate derivative <span>$\frac{dy}{dy_i}$</span> is known as a <em>sensitivity</em>.</p><p>This all seems very academic, so we need to explain why it might make a difference to performance. I&#39;ll give two related explanations: dealing with mulitple variables, and working with vectors rather than scalars.</p><h2 id="Explanation-1:-Multiple-Variables"><a class="docs-heading-anchor" href="#Explanation-1:-Multiple-Variables">Explanation 1: Multiple Variables</a><a id="Explanation-1:-Multiple-Variables-1"></a><a class="docs-heading-anchor-permalink" href="#Explanation-1:-Multiple-Variables" title="Permalink"></a></h2><p>So far we have dealt only with simple functions that take a number, and return a number. But more generally we&#39;ll deal with functions that take, or produce, multiple numbers of interest.</p><p>For example what if we have a function that returns <em>two</em> numbers, and we want derivatives for both? Do we have to do the whole thing twice over?</p><pre><code class="language-julia">y = quote
  y2 = sin(x^2)
  y3 = y2 * 5
end</code></pre><pre class="documenter-example-output">quote
    #= none:2 =#
    y2 = sin(x ^ 2)
    #= none:3 =#
    y3 = y2 * 5
end</pre><p>Let&#39;s say we want both of the derivatives <span>$\frac{dy_2}{dx}$</span> and <span>$\frac{dy_3}{dx}$</span>. You can probably see where this is going now; the Wengert list representation of this expression has not actually changed!</p><pre><code class="language-julia">Wengert(y)</code></pre><pre class="documenter-example-output">Wengert List
y1 = x ^ 2
y2 = sin(y1)
y3 = y2 * 5
</pre><p>Now, we discussed that when doing forward mode differentiation, we actually calculate <em>every</em> intermediate derivative <span>$\frac{dy_i}{dx}$</span>, which means we get <span>$\frac{dy_2}{dx}$</span> for free. This property goes all the way back to our original, recursive formulation of differentiation, which calculated the derivatives of a complex expression by combining the derivatives of simpler ones.</p><pre><code class="language-julia">derive(Wengert(y), :x)</code></pre><pre class="documenter-example-output">Wengert List
y1 = x ^ 2
y2 = sin(y1)
y3 = y2 * 5
y4 = x ^ 1
y5 = 2 * y4
y6 = cos(y1)
y7 = y6 * y5
y8 = 5 * y7
</pre><p>In our output, <span>$y_7 = \frac{dy_2}{dx}$</span> and <span>$y_8 = \frac{dy_3}{dx}$</span>.</p><p>Let&#39;s consider the opposite situation, a function of two variables <span>$a$</span> and <span>$b$</span>, where we&#39;d like to get <span>$\frac{dy}{da}$</span> and <span>$\frac{dy}{db}$</span>.</p><pre><code class="language-julia">y = :(sin(a) * b)</code></pre><pre class="documenter-example-output">:(sin(a) * b)</pre><pre><code class="language-julia">Wengert(y)</code></pre><pre class="documenter-example-output">Wengert List
y1 = sin(a)
y2 = y1 * b
</pre><p>This one is a bit tougher. We can start the forward-mode differentiation process with <span>$\frac{da}{da} = 1$</span> or with <span>$\frac{db}{db} = 1$</span>, but if we want both we&#39;ll have to go through the entire multiplying-out process twice.</p><p>But both variables ultimately end up at the same place, <span>$y$</span>, and we know that <span>$\frac{dy}{dy} = 1$</span>. Aha, so perhaps we can use reverse mode for this instead!</p><p>Exactly opposite to forward mode, reverse mode gives us every intermediate gradient <span>$\frac{dy_i}{dy}$</span> for free, ultimately leading back in the inputs <span>$\frac{da}{dy}$</span> and <span>$\frac{db}{dy}$</span>.</p><p>It&#39;s easy to see, then, why reverse-mode differentiation – or backpropagation – is so effective for machine learning. In general we have a large computation with millions of parameters, yet only a single scalar loss to optimise. We can get gradients even for these millions of inputs in a single pass, enabling ML to scale to complex tasks like image and voice recognition.</p><h2 id="Explanation-2:-Vector-Calculus"><a class="docs-heading-anchor" href="#Explanation-2:-Vector-Calculus">Explanation 2: Vector Calculus</a><a id="Explanation-2:-Vector-Calculus-1"></a><a class="docs-heading-anchor-permalink" href="#Explanation-2:-Vector-Calculus" title="Permalink"></a></h2><p>So far we have dealt only with simple functions that take a number, and return a number. But more generally we&#39;ll deal with functions that take, or produce, <em>vectors</em> containing multiple numbers of interest.</p><p>It&#39;s useful to consider how our idea of differentiation works when we have vectors. For example, a function that takes a vector of length <span>$2$</span> to another vector of length <span>$2$</span>:</p><pre><code class="language-julia">f(x) = [x[1] * x[2], cos(x[1])]

x = [2, 3]
y = f(x)</code></pre><pre class="documenter-example-output">2-element Vector{Float64}:
  6.0
 -0.4161468365471424</pre><p>We now need to talk about what we mean by <span>$\frac{d}{dx}f(x)$</span>, given that we can&#39;t apply the usual limit rule. What we <em>can</em> do is take the derivative of any scalar <em>element</em> of <span>$y$</span> with respect to any element of <span>$x$</span>. (We&#39;ll use subscripts <span>$x_n$</span> to refer to the <span>$n^{th}$</span> index of <span>$x$</span>.) For example:</p><p class="math-container">\[\begin{align}
\frac{dy_1}{dx_1} &amp;= \frac{d}{dx_1} x_1 \times x_2 = x_2 \\
\frac{dy_1}{dx_2} &amp;= \frac{d}{dx_2} x_1 \times x_2 = x_1 \\
\frac{dy_2}{dx_1} &amp;= \frac{d}{dx_1} \cos(x_1) = -\sin(x_1) \\
\frac{dy_2}{dx_2} &amp;= \frac{d}{dx_2} \cos(x_1) = 0 \\
\end{align}\]</p><p>It&#39;s a little easier if we organise all of these derivatives into a matrix.</p><p class="math-container">\[J_{ij} = \frac{dy_i}{dx_j}\]</p><p>This <span>$2\times2$</span> matrix is called the <em>Jacobian</em>, and in general it&#39;s what we mean by <span>$\frac{dy}{dx}$</span>. (The Jacobian for a scalar function like <span>$y = \sin(x)$</span> only has one element, so it&#39;s consistent with our current idea of the derivative <span>$\frac{dy}{dx}$</span>.) The key point here is that the Jacobian is a potentially large object: it has a size <code>length(y) * length(x)</code>. Now, we discussed that the distinction between forward and reverse mode is whether we propagate <span>$\frac{dy_i}{dx}$</span> or <span>$\frac{dy}{dy_i}$</span>, which can have a size of either <code>length(y_i) * length(x)</code> or <code>length(y) * length(y_i)</code>.</p><p>It should be clear, then, what mode is better if we have a gazillion inputs and one output. In forward mode we need to carry around a gazillion &quot;perturbations&quot; <em>for each</em> element of <span>$y_i$</span>, whereas in reverse we only need a gradient of the same size of <span>$x$</span>. And vice versa.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../intro/">« Intro</a><a class="docs-footer-nextpage" href="../forward/">Forward »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.3 on <span class="colophon-date" title="Friday 9 July 2021 08:17">Friday 9 July 2021</span>. Using Julia version 1.6.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
